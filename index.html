<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKTK Feed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }

        #feed-container {
            height: 100vh;
            width: 100vw;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            background: #000;
        }

        .video-card {
            height: 100vh;
            width: 100%;
            position: relative;
            scroll-snap-align: start;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ø¬Ø¹Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
            max-width: 500px; /* Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ø³ÙŠØ¨ */
        }

        /* Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-info {
            position: absolute;
            bottom: 20px;
            right: 10px;
            left: 70px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
            z-index: 2;
            text-align: right;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            pointer-events: none; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ù† Ø®Ù„Ø§Ù„Ù‡ */
        }
        
        .username { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .verified { color: #20D5EC; font-size: 0.8em; }
        .desc { font-size: 0.95em; line-height: 1.4; margin-bottom: 10px; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            position: absolute;
            bottom: 30px;
            left: 10px;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        
        .action-btn { text-align: center; cursor: pointer; }
        .icon-box {
            background: rgba(0,0,0,0.4);
            width: 45px; height: 45px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px;
            margin-bottom: 5px;
            transition: 0.2s;
            color: white;
        }
        .icon-box:active { transform: scale(0.9); }
        .count { font-size: 12px; font-weight: 600; text-shadow: 1px 1px 2px black; }
        
        /* Ø§Ù„Ù‚Ø±Øµ Ø§Ù„Ø¯ÙˆØ§Ø± */
        .music-disc {
            width: 45px; height: 45px;
            background: #222;
            border-radius: 50%;
            border: 8px solid #151515;
            background-image: url('https://cdn-icons-png.flaticon.com/512/1754/1754432.png');
            background-size: cover;
            animation: spin 5s linear infinite;
            margin-top: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="feed-container">
    <div style="height:100vh; display:flex; justify-content:center; align-items:center;">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
    const firebaseConfig = {
        apiKey: "AIzaSyC59tNY6IlcGI7XSd1-yDTcN1Iux5zv7k8",
        authDomain: "tktk-4f724.firebaseapp.com",
        projectId: "tktk-4f724",
        storageBucket: "tktk-4f724.firebasestorage.app",
        messagingSenderId: "349884221151",
        appId: "1:349884221151:web:68d68a27b7fef09ad40b6a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const feedContainer = document.getElementById('feed-container');

    const q = query(collection(db, "videos"), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
        feedContainer.innerHTML = ""; 

        if (!snapshot.empty) {
            snapshot.forEach((doc) => {
                const data = doc.data();
                if(data.url) {
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… preload="metadata" Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    // Ø³Ù†ØºÙŠØ±Ù‡ Ø¥Ù„Ù‰ auto Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø±
                    card.innerHTML = `
                        <video src="${data.url}" loop playsinline preload="metadata" onclick="togglePlay(this)"></video>
                        
                        <div class="bottom-info">
                            <div class="username">
                                @Admin <i class="fas fa-check-circle verified"></i>
                            </div>
                            <div class="desc">${data.title || 'ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯'}</div>
                            <div style="font-size:0.8em; opacity:0.8;">ğŸµ Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ - Music Track</div>
                        </div>

                        <div class="sidebar">
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-heart" style="color:#fe2c55"></i></div>
                                <span class="count">${data.stats?.likes || 0}</span>
                            </div>
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-comment-dots"></i></div>
                                <span class="count">${data.stats?.views || '10k'}</span>
                            </div>
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-bookmark" style="color:#f1c40f"></i></div>
                                <span class="count">${data.stats?.saves || 0}</span>
                            </div>
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-share"></i></div>
                                <span class="count">${data.stats?.shares || 0}</span>
                            </div>
                            <div class="action-btn" onclick="window.open('${data.url}', '_blank')">
                                <div class="icon-box"><i class="fas fa-download"></i></div>
                            </div>
                            <div class="music-disc"></div>
                        </div>
                    `;
                    feedContainer.appendChild(card);
                }
            });
            setupScrollObserver();
        } else {
            feedContainer.innerHTML = "<h3 style='color:white; margin-top:50px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>";
        }
    });

    // ğŸŒŸ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
    function setupScrollObserver() {
        const videos = document.querySelectorAll('video');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target;
                
                if (entry.isIntersecting) {
                    // 1. Ø¥ÙŠÙ‚Ø§Ù ÙƒÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                    document.querySelectorAll('video').forEach(v => {
                        if (v !== video) {
                            v.pause();
                            v.currentTime = 0;
                        }
                    });

                    // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    // Ù†ØºÙŠØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù€ auto Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¢Ù†
                    video.preload = "auto";
                    video.play().catch(e => {
                        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØµÙˆØªØŒ Ù†Ø´ØºÙ„Ù‡ ØµØ§Ù…Øª
                        // video.muted = true; video.play(); 
                    });

                    // 3. ğŸš€ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¨Ù‚ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ (Background Loading)
                    // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø± Ù„Ø¹Ø¯Ù… Ø§Ù„ØªÙ‚Ø·ÙŠØ¹
                    const parentCard = video.closest('.video-card');
                    const nextCard = parentCard.nextElementSibling;
                    if (nextCard) {
                        const nextVideo = nextCard.querySelector('video');
                        if (nextVideo) {
                            nextVideo.preload = "auto"; // Ø§Ø¨Ø¯Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù‚Ø§Ø¯Ù… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                        }
                    }

                } else {
                    video.pause();
                }
            });
        }, { threshold: 0.6 });

        videos.forEach(video => observer.observe(video));
    }

    window.togglePlay = (video) => {
        if (video.paused) video.play();
        else video.pause();
    };
</script>

</body>
</html>
