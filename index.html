<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKTK Feed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        #feed-container {
            height: 100vh;
            width: 100vw;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
        }

        .video-card {
            height: 100vh;
            width: 100%;
            position: relative;
            scroll-snap-align: start;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            max-width: 500px; /* Ù„Ù„Ù‡ÙˆØ§ØªÙ */
        }

        /* Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø§Ø³Ù…) */
        .bottom-info {
            position: absolute;
            bottom: 20px;
            right: 15px;
            left: 70px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
            z-index: 2;
            text-align: right;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .username { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .verified { color: #20D5EC; font-size: 0.8em; } /* Ù…ÙŠØ²Ø© 1: Ø§Ù„ØªÙˆØ«ÙŠÙ‚ */
        .desc { font-size: 0.9em; line-height: 1.4; margin-bottom: 10px; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ù„Ø§ÙŠÙƒØŒ Ø´ÙŠØ±ØŒ Ø­ÙØ¸) */
        .sidebar {
            position: absolute;
            bottom: 30px;
            left: 10px;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        
        .action-btn { text-align: center; }
        .icon-box {
            background: rgba(0,0,0,0.4);
            width: 45px; height: 45px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px;
            margin-bottom: 5px;
            transition: 0.2s;
            cursor: pointer;
        }
        .icon-box:hover { transform: scale(1.1); background: rgba(255,255,255,0.1); }
        .count { font-size: 12px; font-weight: bold; }
        
        /* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ¨ÙŠØ± Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„ */
        .play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
            cursor: pointer;
        }
        .play-btn-big { font-size: 60px; color: rgba(255,255,255,0.8); }

        /* Ù…ÙŠØ²Ø© 2: Ø§Ù„Ù‚Ø±Øµ Ø§Ù„Ø¯ÙˆØ§Ø± Ù„Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ */
        .music-disc {
            width: 45px; height: 45px;
            background: #222;
            border-radius: 50%;
            border: 8px solid #111;
            background-image: url('https://cdn-icons-png.flaticon.com/512/1754/1754432.png');
            background-size: cover;
            animation: spin 4s linear infinite;
            margin-top: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="feed-container">
    <div style="height:100vh; display:flex; justify-content:center; align-items:center;">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC59tNY6IlcGI7XSd1-yDTcN1Iux5zv7k8",
        authDomain: "tktk-4f724.firebaseapp.com",
        projectId: "tktk-4f724",
        storageBucket: "tktk-4f724.firebasestorage.app",
        messagingSenderId: "349884221151",
        appId: "1:349884221151:web:68d68a27b7fef09ad40b6a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const feedContainer = document.getElementById('feed-container');

    const q = query(collection(db, "videos"), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
        feedContainer.innerHTML = ""; 

        if (!snapshot.empty) {
            let index = 0;
            snapshot.forEach((doc) => {
                const data = doc.data();
                if(data.url) {
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    
                    // ØªØ­Ø¶ÙŠØ± Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·
                    let playOverlayHTML = '';
                    let autoPlayAttr = 'loop playsinline';
                    
                    if (index === 0) {
                        // Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„: Ù„Ø§ ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙˆÙŠØ¸Ù‡Ø± Ø²Ø± ØªØ´ØºÙŠÙ„
                        playOverlayHTML = `
                            <div class="play-overlay" onclick="startFirstVideo(this)">
                                <i class="fas fa-play play-btn-big"></i>
                            </div>
                        `;
                    } else {
                        // Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (Observer)
                        autoPlayAttr = 'loop playsinline muted'; // muted Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    }

                    card.innerHTML = `
                        <video src="${data.url}" ${autoPlayAttr} class="vid-${index}"></video>
                        ${playOverlayHTML}
                        
                        <div class="bottom-info">
                            <div class="username">
                                @Admin <i class="fas fa-check-circle verified"></i> </div>
                            <div class="desc">${data.title || 'ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯'}</div>
                            <div style="font-size:0.8em; opacity:0.7;">ğŸµ Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ - Admin Music</div>
                        </div>

                        <div class="sidebar">
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-heart" style="color:#fe2c55"></i></div>
                                <span class="count">${data.stats?.likes || 0}</span>
                            </div>
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-comment-dots"></i></div>
                                <span class="count">204</span> </div>
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-bookmark" style="color:#f1c40f"></i></div>
                                <span class="count">${data.stats?.saves || 0}</span>
                            </div>
                            <div class="action-btn">
                                <div class="icon-box"><i class="fas fa-share"></i></div>
                                <span class="count">${data.stats?.shares || 0}</span>
                            </div>
                             <div class="action-btn" onclick="window.open('${data.url}', '_blank')">
                                <div class="icon-box"><i class="fas fa-download"></i></div>
                            </div>
                            
                            <div class="music-disc"></div>
                        </div>
                    `;
                    feedContainer.appendChild(card);
                    index++;
                }
            });
            setupScrollObserver();
        } else {
            feedContainer.innerHTML = "<h3 style='color:white; margin-top:50px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>";
        }
    });

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹
    window.startFirstVideo = (overlay) => {
        const video = overlay.parentElement.querySelector('video');
        overlay.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
        video.muted = false; // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
        video.play();
    };

    // ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
    function setupScrollObserver() {
        const videos = document.querySelectorAll('video');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                // Ù†ØªØ®Ø·Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„ Ù„Ø£Ù†Ù‡ ÙŠØ¹Ù…Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                if (entry.target.classList.contains('vid-0') && !entry.target.paused) return;

                if (entry.isIntersecting) {
                    entry.target.play().catch(()=> console.log('Autoplay blocked'));
                } else {
                    entry.target.pause();
                    entry.target.currentTime = 0;
                }
            });
        }, { threshold: 0.6 });

        videos.forEach(video => observer.observe(video));
    }
</script>

</body>
</html>
